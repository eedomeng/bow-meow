<!DOCTYPE html>

<!-- =========================================================
* Sneat - Bootstrap 5 HTML Admin Template - Pro | v1.0.0
==============================================================

* Product Page: https://themeselection.com/products/sneat-bootstrap-html-admin-template/
* Created by: ThemeSelection
* License: You must have a valid license purchased in order to legally use the theme for your project.
* Copyright ThemeSelection (https://themeselection.com)

=========================================================
 -->
<!-- beautify ignore:start -->
<html lang="en" class="light-style layout-menu-fixed" dir="ltr"
   data-theme="theme-default" data-assets-path="../assets/"
   data-template="vertical-menu-template-free"
   
   xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{layout}"
   
   >
<head>
   
	<!-- 사진 업로드 스크립트 -->
    <script src="../assets/js/pages-account-settings-account.js"></script>
    <!-- 외부url사용 refer 해제? -->
    <img referrerpolicy="no-referrer" th:src="${#authentication.principal.profileImageUrl}" />
</head>

<body>
   <!-- Layout wrapper -->
   <div class="layout-wrapper layout-content-navbar" layout:fragment="content">
      <div class="layout-container">
         <!-- Menu -->
         <aside th:replace="fragments :: aside">
         </aside>
         
         <!-- / Menu -->

         <!-- Layout container -->
         <div class="layout-page">
            <!-- Navbar -->

            <nav th:replace="fragments :: nav">
            </nav>
            <!-- / Navbar -->

            <!-- Content wrapper -->
            <div class="content-wrapper">
               <!-- Content -->
         <div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
      <div class="col-md-12">
        
        <div class="card mb-4">
        
          <h5 class="card-header">Profile Details</h5>
          
          <!-- Account -->
          <div class="card-body">
     		<div class="d-flex align-items-start align-items-sm-center gap-4">
     			<form id="userProfileImageForm">
			        <input
		              type="file"
		              id="userProfileImageinput"
		              name="profileImageFile"
		              style="display:none;"
		              accept="image/png, image/jpeg" />
	            </form>
		        
		        <img
		          src="#"
		          alt="user-avatar"
		          class="d-block rounded"
		          height="100"
		          width="100"
		          id="userProfileImage" />
		          
		        <div class="button-wrapper">
		            <button class="btn btn-primary me-2 mb-4" th:userImage="${#authentication.principal.userId}" onclick="profileImageUpload(this.getAttribute('userImage'))">
		            	<span class="d-none d-sm-block">Upload new photo</span>
		            	<i class="bx bx-upload d-block d-sm-none"></i>
					</button>
			              
		            <p class="text-muted mb-0">Allowed JPG, GIF or PNG. Max size of 800K</p>
		        </div>
     		</div>
   		  </div>
                    <hr class="my-0" />
                    
                    <div class="card-body">
                      
                        <div class="row">
                          <div class="mb-3 col-md-6">
                            <label for="userId" class="form-label">ID</label>
                            <input
                              class="form-control"
                              type="text"
                              id="userId"
                              name="userId"
                              readonly="readonly"
                              th:value="${#authentication.principal.userId}"
                              autofocus
                            />
                          </div>
                          
                           <div class="mb-3 col-md-6">
                            <label for="email" class="form-label">E-mail</label>
                            <input
                              class="form-control"
                              type="text"
                              id="email"
                              name="email"
                              readonly="readonly"
                              th:value="${#authentication.principal.email}"
                            />
                          </div>
                          
                          <div class="mb-3 col-md-6">
                            <label for="password" class="form-label">Password</label>
                            <input class="form-control" type="password" name="password" id="password" placeholder="영문 대소문자, 특수문자, 숫자를 포함하여 8자 이상을 입력하세요." />
                          </div>
                          
                          <div class="mb-3 col-md-6">
                            <label for="check_password" class="form-label">Check Password</label>
                            <input class="form-control" type="password" name="check_password" id="check_password" placeholder="영문 대소문자, 특수문자, 숫자를 포함하여 8자 이상을 입력하세요."/>
                        	<span class="valid_info" id="pwCheck"></span>
                          </div>
                          
                          <div class="mb-3 col-md-6">
                            <label for="nickname" class="form-label">nickname</label>
                            <input
                              class="form-control"
                              type="text"
                              id="nickname"
                              name="nickname"
                              placeholder="John"
                              th:value="${#authentication.principal.nickname}"
                              autofocus
                            />
                          </div>
                      
                      
                    </div>
                     <button type="button" class="btn deactivate-account" style="background-color:pink;color: black;" th:dm="${#authentication.principal.userId}" th:onclick="update(this.getAttribute('dm'))">submit</button>
                 	</div>
                    <!-- /Account -->
                  
                  <hr class="my-0" />
                  
                  <!-- delete account -->
                  <div class="card">
                    <h5 class="card-header">회원탈퇴</h5>
                    <div class="card-body">
                      <div class="mb-3 col-12 mb-0">
                        <div class="alert alert-warning">
                          <h6 class="alert-heading fw-bold mb-1">Are you sure you want to delete your account?</h6>
                          <p class="mb-0">Once you delete your account, there is no going back. Please be certain.</p>
                        </div>
                      </div>
                      <form id="formAccountDeactivation_tt" onsubmit="return false">
                        <div class="form-check mb-3">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            name="accountActivation"
                            id="accountActivation"
                          />
                          <label class="form-check-label" for="accountActivation"
                            >I confirm my account deactivation</label
                          >
                        </div>
                        <button type="submit" class="btn btn-danger deactivate-account">Deactivate Account</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
               <!-- / Content -->

               <!-- Footer -->
               <footer class="content-footer footer bg-footer-theme">
                  <div
                     class="container-xxl d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column">
                     <div class="mb-2 mb-md-0">
                        ©
                        <script>
                    document.write(new Date().getFullYear());
                  </script>
                        , made with ❤️ by <a href="https://themeselection.com"
                           target="_blank" class="footer-link fw-bolder">ThemeSelection</a>
                     </div>
                     <div>
                        <a href="https://themeselection.com/license/"
                           class="footer-link me-4" target="_blank">License</a> <a
                           href="https://themeselection.com/" target="_blank"
                           class="footer-link me-4">More Themes</a> <a
                           href="https://themeselection.com/demo/sneat-bootstrap-html-admin-template/documentation/"
                           target="_blank" class="footer-link me-4">Documentation</a>

                        <a
                           href="https://github.com/themeselection/sneat-html-admin-template-free/issues"
                           target="_blank" class="footer-link me-4">Support</a>
                     </div>
                  </div>
               </footer>
               <!-- / Footer -->

               <div class="content-backdrop fade"></div>
            </div>
            <!-- Content wrapper -->
         </div>
         <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>
      </div>
   </div>
   <!-- / Layout wrapper -->

  <script type="text/javascript" layout:fragment="script">
  
  function update(userId){
	  
	  let checkPassword = $("#check_password").val();
	  
	  let data = {
		nickname: $("#nickname").val(),
		password: $("#password").val(),
	  };
	  
	  if(!data.nickname || data.nickname.trim() === "" || !data.password || data.password.trim() === ""){
		  alert("공백 또는 입력하지 않은 부분이 있습니다.");
          return false;
		  
	  } else if(!/(?!.*[ㄱ-힣])(?=.*\d)(?=.*[a-zA-Z])(?=.*[^a-zA-Z0-9ㄱ-힣])(?=.{8,})/.test(data.password)){
		  alert("비밀번호는 영문, 숫자, 특수문자 8자 이상");
		  $("#password").focus();
		  return false;
		  
	  } else if(data.password != checkPassword){
		  pwCheck.innerHTML = "비밀번호가 같지않습니다.";
		  return false;
	  } 
	  
	  const confirmCheck = confirm("수정하시겠습니까?");
	  
	  if(confirmCheck == true){
		  $.ajax({
			  type: "PUT",
			  url:'/api/user',
			  data: data,
			  contentType: "application/x-www-form-urlencoded; charset=utf-8",
			  dataType: "json"
			  
		  }).done(res => {
			  console.log("update 성공");
			  location.href = `/`
			  
		  }).fail(eroor => {
			  console.log("update 실패");
			  
		  });
		  
	  }
	
  }
  
  function profileImageUpload(userId){
	  
	  console.log("pageUserId", userId);
	  
	  $("#userProfileImageinput").click();
	  
	  $("#userProfileImageinput").on("change", (e) => {
		  let f = e.target.files[0];
		  console.log(f);
		  
		  if(!f.type.match("image.*")){
			  alert("이미지를 등록해야합니다.")
			  return;
		  }
		  
		  // 서버에 이미지 전송
		  let profileImageForm = $("#userProfileImageForm")[0];
		  console.log(profileImageForm);
		  
		  // FormData 객체를 이용하면 form 태그의 필드와 그 값을 나타내는 일련의 key/value 쌍을 담을 수 있다.
		  let formData = new FormData(profileImageForm);
		  
		  $.ajax({
			  type: "PUT",
			  url: 'api/user/profileImageUrl',
			  data: formData,
			  contentType: false, // x-www-form-urlencoded로 파상되는 것을 방지
			  processData: false, // contentType을 false로 줬을 때 QueryString 자동 설정 해제
			  enctype: "multipart/form-data",
			  dataType: "json"
			  
		  }).done(res => {
			  let reader = new FileReader();
			  reader.onload = (e) => {
				  $("#userProfileImage").attr("src", e.target.result);
			  }
			  
			  reader.readAsDataURL(f);
			  
		  }).fail(error => {
			  console.log("오류", error);
		  });
		  
		  
		  
	  });
	  
	  
  }
  
  
  </script>

</body>
</html>